# Mermaid图表提取与转换 Chrome插件 - 进度文档

## 当前完成情况

### 已完成功能

1. ✅ **基础框架搭建**
   - 基于Manifest V3规范的Chrome扩展结构
   - React + TypeScript开发环境配置
   - Webpack构建流程设置

2. ✅ **Mermaid渲染核心**
   - 已实现MermaidRenderer React组件
   - 支持最新版Mermaid.js库
   - 实现错误处理和调试功能
   - 优化渲染性能

3. ✅ **侧边栏UI骨架**
   - 侧边栏基础布局
   - 图表列表组件
   - 复制按钮功能
   - 无图表时的提示信息

4. ✅ **转图片页面结构**
   - 独立页面左右分栏布局
   - 编辑器-预览区配置
   - 实时渲染机制
   - 基础导出按钮

### 正在开发的功能

1. 🔄 **图表检测算法**
   - DOM遍历和分析
   - 多种类型Mermaid图表识别
   - 不同实现方式的兼容性处理
   - 检测结果的分类和展示

2. 🔄 **缩略图生成**
   - 小型预览图自动生成
   - 性能优化处理
   - 大图表适配

### 计划开发的功能

1. ⏳ **多格式导出引擎**
   - SVG原生导出
   - PNG格式转换
   - JPEG格式支持
   - 不同尺寸倍数（1x/2x/3x）支持

2. ⏳ **图表模板系统**
   - 流程图模板
   - 时序图模板
   - 类图模板
   - 状态图模板
   - 甘特图模板

3. ⏳ **用户体验提升**
   - 编辑器语法高亮
   - 主题切换功能
   - 保存/加载配置
   - 错误提示优化
   - 快捷键支持

## 关键里程碑

| 里程碑 | 计划日期 | 实际日期 | 状态 |
|--------|----------|----------|------|
| 基础功能实现 | 2025-03-10 | 2025-03-10 | ✅ 已完成 |
| 图表检测和提取 | 2025-03-20 | - | 🔄 进行中 |
| 图片导出完整实现 | 2025-04-05 | - | ⏳ 未开始 |
| 模板系统完成 | 2025-04-10 | - | ⏳ 未开始 |
| Chrome商店提交 | 2025-05-10 | - | ⏳ 未开始 |
| 正式发布 | 2025-05-20 | - | ⏳ 未开始 |

## 技术挑战与解决方案

| 挑战 | 状态 | 解决方案 |
|------|------|----------|
| 网页内Mermaid图表的准确识别 | 🔄 进行中 | 结合多种检测方法，分析DOM结构和SVG特征 |
| 侧边栏与页面的通信机制 | ✅ 已解决 | 使用Chrome扩展消息传递API，实现侧边栏与内容脚本的双向通信 |
| 图片尺寸和质量控制 | ⏳ 未开始 | 实现可配置的尺寸倍数选项，优化SVG转PNG/JPEG的过程 |
| 跨域限制下的图表处理 | ⏳ 未开始 | 使用Chrome扩展API提供的跨域能力 |
| 大型图表的性能问题 | 🔄 进行中 | 实现渲染限制和优化策略 |
| 缩略图生成优化 | 🔄 进行中 | 使用Web Workers进行缩略图生成，避免阻塞主线程 |

## 下一步计划

1. 完成网页图表检测算法，提高准确率和覆盖率
2. 实现高效的缩略图生成，让侧边栏列表预览更直观
3. 完善多格式导出功能，支持不同尺寸倍数的选择
4. 添加常用图表类型的模板系统，方便用户快速创建图表
5. 优化编辑器体验，添加语法高亮和辅助功能

## 团队协作

| 成员 | 职责 | 当前任务 |
|------|------|----------|
| 开发者A | 前端开发 | 侧边栏界面优化 |
| 开发者B | 核心功能 | 图表检测算法 |
| 开发者C | 图像处理 | 图片导出功能 |
| 测试人员 | 功能测试 | 测试计划制定 |

## 风险评估

| 风险 | 可能性 | 影响 | 缓解策略 |
|------|--------|------|----------|
| Mermaid语法变更 | 中 | 高 | 保持对Mermaid库的更新，实现版本兼容层 |
| 网页结构复杂导致检测失败 | 高 | 中 | 开发多种备选检测策略，提供手动选择功能 |
| 浏览器策略变更影响扩展功能 | 低 | 高 | 关注Chrome扩展平台更新，及时调整实现方式 |
| 大型图表处理性能不足 | 中 | 中 | 实现渐进式渲染和处理大小限制选项 |
| 侧边栏通信延迟 | 中 | 低 | 优化消息传递机制，添加缓存策略 |

## 已解决问题

### 内容安全策略(CSP)问题
- 问题：由于Chrome扩展的内容安全策略限制，不允许使用'unsafe-eval'，但mermaid.js依赖eval函数进行渲染
- 解决方案：
  1. ~~创建独立的HTML文件(mermaid-renderer.html)作为渲染器~~
  2. ~~使用iframe加载渲染器，提供沙盒环境隔离执行Mermaid.js~~
  3. ~~通过postMessage API在主扩展和iframe之间安全通信~~
  4. ~~在manifest.json中配置web_accessible_resources允许访问渲染器页面~~
  5. ~~移除'unsafe-eval'指令，使用标准CSP配置~~

#### 最终解决方案 (2025-03-01)
1. 使用Chrome扩展的沙盒特性
   - 在manifest.json中添加sandbox配置，指定mermaid-renderer.html为沙盒页面
   - 为沙盒页面单独设置CSP规则，允许使用unsafe-inline
   ```json
   "sandbox": {
     "pages": ["mermaid-renderer.html"]
   },
   "content_security_policy": {
     "extension_pages": "script-src 'self'; object-src 'self'",
     "sandbox": "sandbox allow-scripts allow-forms allow-popups; script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; object-src 'self'"
   }
   ```

2. 创建独立的mermaid-script.js
   - 实现动态加载Mermaid库的逻辑
   - 通过postMessage与主扩展通信
   - 在沙盒环境中安全执行操作

### 侧边栏通信机制
- 问题：Chrome扩展侧边栏需要与内容脚本通信获取图表信息
- 解决方案（2025-03-05）：
  1. 使用chrome.tabs.sendMessage在侧边栏和内容脚本之间传递消息
  2. 实现消息类型系统，区分不同操作请求
  3. 添加请求ID和状态跟踪，确保消息匹配
  4. 实现错误处理和超时机制 