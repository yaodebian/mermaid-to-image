<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mermaid Renderer</title>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: transparent;
    }
    #container {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .error-message {
      color: #e53e3e;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 12px;
      border: 1px solid #feb2b2;
      background-color: #fff5f5;
      border-radius: 4px;
      margin: 10px;
      font-size: 14px;
      max-width: 90%;
      overflow-wrap: break-word;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .error-code {
      font-family: monospace;
      background-color: #fff;
      padding: 8px;
      border: 1px solid #eee;
      border-radius: 3px;
      margin-top: 8px;
      white-space: pre-wrap;
      font-size: 12px;
    }
    .error-line {
      background-color: #ffecec;
      font-weight: bold;
    }
    #log-container {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      max-height: 100px;
      overflow-y: auto;
      background: rgba(0,0,0,0.7);
      color: #fff;
      font-size: 10px;
      padding: 4px;
      font-family: monospace;
      display: none;
      z-index: 10000;
    }
    .log-entry {
      padding: 2px 4px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .log-error {
      color: #ff9999;
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="log-container"></div>

  <script>
    let debugMode = false;
    const debugPanel = document.getElementById('log-container');
    
    function log(message) {
      console.log(`[Mermaid Renderer] ${message}`);
      if (debugMode && debugPanel) {
        const time = new Date().toLocaleTimeString();
        debugPanel.innerHTML += `<div class="log-entry log-error">[${time}] ${message}</div>`;
        // 限制日志条数
        if (debugPanel.children.length > 10) {
          debugPanel.removeChild(debugPanel.firstChild);
        }
      }
    }

    // 初始化Mermaid
    try {
      log('初始化Mermaid');
      mermaid.initialize({
        startOnLoad: false,
        theme: 'default',
        securityLevel: 'loose',
        er: { useMaxWidth: false },
        flowchart: { useMaxWidth: false },
        sequence: { useMaxWidth: false },
        journey: { useMaxWidth: false }
      });
      
      // 通知父窗口Mermaid已准备好
      window.parent.postMessage({
        type: 'mermaid-ready',
        success: true
      }, '*');
      log('Mermaid初始化成功，已通知父窗口');
    } catch (err) {
      log(`Mermaid初始化失败: ${err.message}`);
      window.parent.postMessage({
        type: 'mermaid-ready',
        success: false,
        error: err.message || '初始化失败'
      }, '*');
    }

    // 监听来自父窗口的消息
    window.addEventListener('message', function(event) {
      if (!event.data) return;
      
      log(`收到消息: ${event.data.type}`);
      
      if (event.data.type === 'render-mermaid') {
        renderMermaid(event.data.code);
      } else if (event.data.type === 'debug-mode') {
        debugMode = event.data.enabled;
        debugPanel.style.display = debugMode ? 'block' : 'none';
        log(`调试模式: ${debugMode ? '开启' : '关闭'}`);
      }
    });

    function renderMermaid(code) {
      if (!code || typeof code !== 'string') {
        log('渲染失败: 无效的代码');
        sendRenderError('无效的Mermaid代码');
        return;
      }
      
      // 清空代码两端的空白
      code = code.trim();
      
      if (!code) {
        log('跳过渲染: 空代码');
        sendRenderError('请输入Mermaid代码');
        return;
      }
      
      log(`开始渲染代码 (${code.length} 字符)`);
      const container = document.getElementById('container');
      
      // 清空容器
      container.innerHTML = '';
      
      try {
        // 尝试验证语法
        try {
          mermaid.parse(code);
        } catch (parseError) {
          // 如果解析失败，显示详细的语法错误
          log(`解析错误: ${parseError.message}`);
          showSyntaxError(parseError, code);
          return;
        }
        
        // 渲染Mermaid图表
        mermaid.render('mermaid-svg', code)
          .then(result => {
            log('Mermaid渲染成功');
            container.innerHTML = result.svg;
            
            // 获取SVG元素
            const svg = container.querySelector('svg');
            if (svg) {
              // 发送SVG尺寸信息回父窗口
              window.parent.postMessage({
                type: 'mermaid-rendered',
                success: true,
                width: svg.getBoundingClientRect().width,
                height: svg.getBoundingClientRect().height
              }, '*');
            } else {
              sendRenderError('渲染成功但未找到SVG元素');
            }
          })
          .catch(err => {
            showSyntaxError(err, code);
          });
      } catch (err) {
        // 显示错误消息
        showSyntaxError(err, code);
      }
    }
    
    function sendRenderError(errorMessage) {
      log(`渲染错误: ${errorMessage}`);
      
      // 通知父窗口渲染失败
      window.parent.postMessage({
        type: 'mermaid-rendered',
        success: false,
        error: errorMessage
      }, '*');
    }
    
    function showSyntaxError(error, code) {
      log(`显示语法错误: ${error.message}`);
      const container = document.getElementById('container');
      
      // 提取错误行和字符位置
      let errorLine = 'Unknown';
      let errorChar = '';
      let errorMsg = error.message || '未知错误';
      
      const lineMatch = errorMsg.match(/Line (\d+)/i);
      if (lineMatch) {
        errorLine = lineMatch[1];
      }
      
      const charMatch = errorMsg.match(/character (\d+)/i);
      if (charMatch) {
        errorChar = `，字符 ${charMatch[1]}`;
      }
      
      // 创建更友好的错误显示
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      
      // 处理代码片段显示
      let codeHighlight = '';
      if (errorLine !== 'Unknown' && code) {
        const lines = code.split('\n');
        if (errorLine > 0 && errorLine <= lines.length) {
          // 获取有问题的行及其上下文
          const startLine = Math.max(1, parseInt(errorLine) - 1);
          const endLine = Math.min(lines.length, parseInt(errorLine) + 1);
          
          codeHighlight = '<div class="error-code">';
          for (let i = startLine; i <= endLine; i++) {
            const isErrorLine = i === parseInt(errorLine);
            codeHighlight += `<div style="${isErrorLine ? 'background-color:#ffecec;font-weight:bold;' : ''}">${i}: ${lines[i-1]}</div>`;
          }
          codeHighlight += '</div>';
        }
      }
      
      errorDiv.innerHTML = `
        <div class="error-line">Mermaid语法错误</div>
        <div>错误位置: 第 ${errorLine} 行${errorChar}</div>
        <div>错误信息: ${errorMsg}</div>
        ${codeHighlight}
      `;
      
      container.innerHTML = '';
      container.appendChild(errorDiv);
      
      // 通知父窗口渲染失败
      window.parent.postMessage({
        type: 'mermaid-rendered',
        success: false,
        error: `语法错误: 第 ${errorLine} 行${errorChar}`
      }, '*');
    }
    
    // 页面加载完成时再次通知父窗口
    window.addEventListener('load', function() {
      log('页面完全加载');
      window.parent.postMessage({
        type: 'mermaid-ready',
        success: true
      }, '*');
    });
  </script>
</body>
</html> 